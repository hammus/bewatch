"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const events_1 = require("events");
const globby_1 = require("globby");
const callsite_1 = __importDefault(require("callsite"));
const os_1 = require("os");
if (!Array.prototype.unique) {
    Array.prototype.unique = function () {
        return this.filter((value, index) => {
            return this.indexOf(value) === index;
        });
    };
}
class Bewatch extends events_1.EventEmitter {
    /**
     * File Watching using NodeJS fs.watch
     * @param globPattern The glob or array of globs to match against
     * @param watchOptions Options object
     */
    constructor(globPattern, watchOptions = {}) {
        super();
        this.options = { lockDuration: 1000, absolute: true, encoding: "utf-8", persistent: true, recursive: true, verbose: false };
        this.watchers = [];
        this.locked = false;
        this.locks = [];
        this.options = { ...this.options, ...watchOptions };
        // Callsite Gets the directory of the file this constructor was called from so we can glob from there instead of here
        this.options.cwd = (typeof this.options.cwd === "undefined") ? path.dirname(callsite_1.default()[1].getFileName()) : this.options.cwd;
        this.log("Working Directory", this.options.cwd);
        this.log("Options", this.options);
        this.files = this.globFiles(globPattern).map((g) => path.normalize(g));
        this.directories = this.files.map((f) => path.dirname(f)).unique();
    }
    log(...logargs) {
        if (this.options.verbose) {
            // tslint:disable-next-line:no-console
            console.log(`Bewatch::${callsite_1.default()[1].getFunctionName()}`, ...logargs, os_1.EOL);
        }
    }
    globFiles(globPattern) {
        return globby_1.sync(globPattern, this.options);
    }
    isDirectory(source) {
        return fs.lstatSync(source).isDirectory();
    }
    isFile(source) {
        return !fs.lstatSync(source).isDirectory();
    }
    getDirectories(source) {
        return fs.readdirSync(source).map((name) => path.normalize(path.join(source, name))).filter(this.isDirectory);
    }
    getFiles(dir) {
        return fs.readdirSync(dir).map((name) => path.normalize(path.join(dir, name))).filter(this.isFile);
    }
    onFileEvent(e, f) {
        if (this.locked || e !== "change") {
            return;
        }
        this.lock();
        this.log(`Node.js FSEvent: ${e}`, `Node FSEvent File: ${f}`);
        this.emit("all", "change", f);
        this.emit("change", f);
    }
    /**
     * fs.watch event handler for directories
     * We watch directories for add, rename delete events so we can add and remove new listeners as necessary
     *
     * @param e {string} event type
     * @param f {string} file
     * @param dir {string} the directory
     */
    onDirectoryEvent(e, f, dir) {
        if (this.locked || e !== "rename") {
            return;
        }
        this.lock();
        this.log(`Raw FSEvent: ${e}${os_1.EOL}Raw FSEvent File: ${f}${os_1.EOL}Directory: ${dir}${os_1.EOL}`);
        const abs = path.join(dir, path.basename(f));
        if (!fs.existsSync(abs)) {
            const renamedFile = this.getRenamedFiles(dir);
            if (typeof renamedFile !== "undefined") {
                this.log(`Old File: ${abs}`);
                this.log(`Renamed File: ${renamedFile}`);
                this.emit("all", "rename", abs, renamedFile);
                this.emit("rename", abs, renamedFile);
                this.removeWatcher(abs);
            }
            else {
                this.emit("all", "delete", abs);
                this.emit("delete", abs);
            }
            return;
        }
        if (!this.files.includes(abs)) {
            // Create
            this.watchers.push(this.createFileWatcher(abs));
            this.emit("all", "add", abs);
            this.emit("add", abs);
        }
    }
    removeWatcher(file) {
        const watcherStruct = this.getWatcher(file);
        if (typeof watcherStruct !== "undefined") {
            watcherStruct.watcher.close();
            this.watchers.splice(this.watchers.indexOf(watcherStruct), 1);
        }
    }
    getRenamedFiles(dir) {
        const files = this.getFiles(dir);
        this.log("Files on Disk:" + os_1.EOL + JSON.stringify(files, null, 2));
        this.log("Watched Files:" + os_1.EOL + JSON.stringify(this.files, null, 2));
        for (const f of files) {
            if (!this.files.includes(f)) {
                return f;
            }
        }
        return undefined;
    }
    createFileWatcher(file) {
        return {
            target: file,
            watcher: fs.watch(file, this.options, (e, _) => { this.onFileEvent(e, file); })
        };
    }
    createDirWatcher(dir) {
        return {
            target: dir,
            watcher: fs.watch(dir, this.options, (e, f) => { this.onDirectoryEvent(e, f, dir); })
        };
    }
    getWatcher(filename) {
        return this.watchers.find((w) => path.normalize(w.target) === path.normalize(filename));
    }
    lock() {
        this.locked = true;
        setTimeout(() => { this.locked = false; }, this.options.lockDuration);
    }
    /**
     * Attachs watch listeners and starts watching specified files
     * Available events are
     * `add` - Emitted when a file is created
     * `delete` - Emitted when a file is deleted
     * `change` - Emitted when a file change is detected
     * `rename` - Emitted when a file is renamed
     * `all` - Emitted for all the above events
     */
    Start() {
        this.log("Watching Files:" + os_1.EOL + this.files.map((f) => `${f}`).join(os_1.EOL));
        for (const file of this.files) {
            this.watchers.push(this.createFileWatcher(file));
        }
        this.log("Watching Directories:" + os_1.EOL + this.directories.map((f) => `${f}`).join(os_1.EOL));
        for (const dir of this.directories) {
            this.watchers.push(this.createDirWatcher(dir));
        }
        return this;
    }
}
exports.Bewatch = Bewatch;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmV3YXRjaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9CZXdhdGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEseUJBQTBCO0FBQzFCLDZCQUE4QjtBQUM5QixtQ0FBc0M7QUFDdEMsbUNBQXNDO0FBQ3RDLHdEQUFnQztBQUVoQywyQkFBeUI7QUFvRHpCLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRTtJQUN6QixLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRztRQUNyQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFVLEVBQUUsS0FBYSxFQUFFLEVBQUU7WUFDN0MsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLEtBQUssQ0FBQztRQUN6QyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQTtDQUNKO0FBSUQsYUFBcUIsU0FBUSxxQkFBWTtJQVFyQzs7OztPQUlHO0lBQ0gsWUFBWSxXQUE4QixFQUFFLGVBQStCLEVBQUU7UUFDekUsS0FBSyxFQUFFLENBQUM7UUFYRixZQUFPLEdBQW1CLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsQ0FBQztRQUN2SSxhQUFRLEdBQW9CLEVBQUUsQ0FBQztRQUMvQixXQUFNLEdBQVksS0FBSyxDQUFDO1FBQ3hCLFVBQUssR0FBa0IsRUFBRSxDQUFDO1FBU2hDLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsR0FBRyxZQUFZLEVBQUUsQ0FBQztRQUVwRCxxSEFBcUg7UUFDckgsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEdBQUcsQ0FBQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsR0FB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Q0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQzFFLENBQUM7SUFHRDs7Ozs7Ozs7T0FRRztJQUNJLEtBQUs7UUFDUixJQUFJLENBQUMsR0FBRyxDQUFDLGlCQUFpQixHQUFHLFFBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzVFLEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUMzQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztTQUNwRDtRQUNELElBQUksQ0FBQyxHQUFHLENBQUMsdUJBQXVCLEdBQUcsUUFBRyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQUcsQ0FBQyxDQUFDLENBQUM7UUFDeEYsS0FBSyxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ2xEO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUNKO0FBdEtELDBCQXNLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyA9IHJlcXVpcmUoXCJmc1wiKTtcclxuaW1wb3J0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSBcImV2ZW50c1wiO1xyXG5pbXBvcnQgeyBzeW5jIGFzIGdsb2IgfSBmcm9tIFwiZ2xvYmJ5XCI7XHJcbmltcG9ydCBDYWxsc2l0ZSBmcm9tIFwiY2FsbHNpdGVcIjtcclxuaW1wb3J0IHsgT3B0aW9ucyBhcyBGYXN0R2xvYk9wdGlvbnMgfSBmcm9tICdmYXN0LWdsb2InO1xyXG5pbXBvcnQgeyBFT0wgfSBmcm9tIFwib3NcIjtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRlNXYXRjaE9wdGlvbnMge1xyXG4gICAgZW5jb2Rpbmc/OiBzdHJpbmc7XHJcbiAgICBwZXJzaXN0ZW50PzogYm9vbGVhbjtcclxuICAgIHJlY3Vyc2l2ZT86IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgV2F0Y2hlclN0cnVjdCB7XHJcbiAgICB0YXJnZXQ6IHN0cmluZztcclxuICAgIHdhdGNoZXI6IGZzLkZTV2F0Y2hlcjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGU0V2ZW50TG9jayB7XHJcbiAgICBmaWxlbmFtZTogc3RyaW5nO1xyXG4gICAgbG9ja1RpbWU6IG51bWJlcjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGaWxlRGVzY3JpcHRvciB7XHJcbiAgICBiYXNlbmFtZTogc3RyaW5nO1xyXG4gICAgZmQ6IG51bWJlcjtcclxuICAgIGRpcm5hbWU6IHN0cmluZztcclxuICAgIGFic29sdXRlOiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgV2F0Y2hlck9wdGlvbnMgZXh0ZW5kcyBGU1dhdGNoT3B0aW9ucywgRmFzdEdsb2JPcHRpb25zIHtcclxuICAgIC8qKlxyXG4gICAgICogVGhlIGRlbGF5IGluIG1pbGxpc2Vjb25kcyBiZWZvcmUgZW1pdHRpbmcgYSBuZXcgRXZlbnRcclxuICAgICAqIE5vZGVKUyBmcy53YXRjaCBlbWl0cyBkdXBsaWNhdGUgZXZlbnRzIGFtb25nIG90aGVyIGlkaW9zeW5jcmFzZXMsIHRoaXMgY29udHJvbHMgaG93IGxvbmcgd2Ugd2FpdCBiZWZvcmUgcmVsYXlpbmcgZXZlbnRzXHJcbiAgICAgKiBAZGVmYXVsdCA1MDAwXHJcbiAgICAgKi9cclxuICAgIGxvY2tEdXJhdGlvbj86IG51bWJlcjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEVuYWJsZXMgdmVyYm9zZSBsb2dnaW5nXHJcbiAgICAgKiBAZGVmYXVsdCBmYWxzZVxyXG4gICAgICovXHJcbiAgICB2ZXJib3NlPzogYm9vbGVhbjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEZXNjcmlwdG9yRGlyZWN0b3J5IHtcclxuICAgIGRpcm5hbWU6IHN0cmluZztcclxuICAgIGRlc2NyaXB0b3JzOiBGaWxlRGVzY3JpcHRvcltdO1xyXG59XHJcblxyXG4vLyBBZGQgdGhlIHVuaXF1ZSBleHRlbnNpb24gbWV0aG9kIHRvIHRoZSBBcnJheSBwcm90b3R5cGVcclxuZGVjbGFyZSBnbG9iYWwge1xyXG4gICAgaW50ZXJmYWNlIEFycmF5PFQ+IHtcclxuICAgICAgICB1bmlxdWU6ICgpID0+IEFycmF5PFQ+O1xyXG4gICAgfVxyXG59XHJcblxyXG5pZiAoIUFycmF5LnByb3RvdHlwZS51bmlxdWUpIHtcclxuICAgIEFycmF5LnByb3RvdHlwZS51bmlxdWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKCh2YWx1ZTogYW55LCBpbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmluZGV4T2YodmFsdWUpID09PSBpbmRleDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IHR5cGUgTGVnYWxFdmVudHMgPSBcImFkZFwiIHwgXCJkZWxldGVcIiB8IFwiY2hhbmdlXCIgfCBcInJlbmFtZVwiIHwgXCJhbGxcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBCZXdhdGNoIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcclxuICAgIHByb3RlY3RlZCBmaWxlczogc3RyaW5nW107XHJcbiAgICBwcm90ZWN0ZWQgZGlyZWN0b3JpZXM6IHN0cmluZ1tdO1xyXG4gICAgcHJvdGVjdGVkIG9wdGlvbnM6IFdhdGNoZXJPcHRpb25zID0geyBsb2NrRHVyYXRpb246IDEwMDAsIGFic29sdXRlOiB0cnVlLCBlbmNvZGluZzogXCJ1dGYtOFwiLCBwZXJzaXN0ZW50OiB0cnVlLCByZWN1cnNpdmU6IHRydWUsIHZlcmJvc2U6IGZhbHNlIH07XHJcbiAgICBwcm90ZWN0ZWQgd2F0Y2hlcnM6IFdhdGNoZXJTdHJ1Y3RbXSA9IFtdO1xyXG4gICAgcHJvdGVjdGVkIGxvY2tlZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgcHJvdGVjdGVkIGxvY2tzOiBGU0V2ZW50TG9ja1tdID0gW107XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBGaWxlIFdhdGNoaW5nIHVzaW5nIE5vZGVKUyBmcy53YXRjaFxyXG4gICAgICogQHBhcmFtIGdsb2JQYXR0ZXJuIFRoZSBnbG9iIG9yIGFycmF5IG9mIGdsb2JzIHRvIG1hdGNoIGFnYWluc3RcclxuICAgICAqIEBwYXJhbSB3YXRjaE9wdGlvbnMgT3B0aW9ucyBvYmplY3QgXHJcbiAgICAgKi9cclxuICAgIGNvbnN0cnVjdG9yKGdsb2JQYXR0ZXJuOiBzdHJpbmcgfCBzdHJpbmdbXSwgd2F0Y2hPcHRpb25zOiBXYXRjaGVyT3B0aW9ucyA9IHt9KSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICB0aGlzLm9wdGlvbnMgPSB7IC4uLnRoaXMub3B0aW9ucywgLi4ud2F0Y2hPcHRpb25zIH07XHJcblxyXG4gICAgICAgIC8vIENhbGxzaXRlIEdldHMgdGhlIGRpcmVjdG9yeSBvZiB0aGUgZmlsZSB0aGlzIGNvbnN0cnVjdG9yIHdhcyBjYWxsZWQgZnJvbSBzbyB3ZSBjYW4gZ2xvYiBmcm9tIHRoZXJlIGluc3RlYWQgb2YgaGVyZVxyXG4gICAgICAgIHRoaXMub3B0aW9ucy5jd2QgPSAodHlwZW9mIHRoaXMub3B0aW9ucy5jd2QgPT09IFwidW5kZWZpbmVkXCIpID8gcGF0aC5kaXJuYW1lKENhbGxzaXRlKClbMV0uZ2V0RmlsZU5hbWUoKSkgOiB0aGlzLm9wdGlvbnMuY3dkO1xyXG5cclxuICAgICAgICB0aGlzLmxvZyhcIldvcmtpbmcgRGlyZWN0b3J5XCIsIHRoaXMub3B0aW9ucy5jd2QpO1xyXG4gICAgICAgIHRoaXMubG9nKFwiT3B0aW9uc1wiLCB0aGlzLm9wdGlvbnMpO1xyXG5cclxuICAgICAgICB0aGlzLmZpbGVzID0gdGhpcy5nbG9iRmlsZXMoZ2xvYlBhdHRlcm4pLm1hcCgoZykgPT4gcGF0aC5ub3JtYWxpemUoZykpO1xyXG4gICAgICAgIHRoaXMuZGlyZWN0b3JpZXMgPSB0aGlzLmZpbGVzLm1hcCgoZikgPT4gcGF0aC5kaXJuYW1lKGYpKS51bmlxdWUoKTtcclxuXHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBsb2coLi4ubG9nYXJnczogYW55W10pOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnZlcmJvc2UpIHtcclxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcclxuICAgICAgICAgICAgY29uc29sZS5sb2coYEJld2F0Y2g6OiR7Q2FsbHNpdGUoKVsxXS5nZXRGdW5jdGlvbk5hbWUoKX1gLCAuLi5sb2dhcmdzLCBFT0wpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZ2xvYkZpbGVzKGdsb2JQYXR0ZXJuOiBzdHJpbmcgfCBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcclxuICAgICAgICByZXR1cm4gZ2xvYihnbG9iUGF0dGVybiwgdGhpcy5vcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgaXNEaXJlY3Rvcnkoc291cmNlOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gZnMubHN0YXRTeW5jKHNvdXJjZSkuaXNEaXJlY3RvcnkoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgaXNGaWxlKHNvdXJjZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuICFmcy5sc3RhdFN5bmMoc291cmNlKS5pc0RpcmVjdG9yeSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXREaXJlY3Rvcmllcyhzb3VyY2U6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgICAgICByZXR1cm4gZnMucmVhZGRpclN5bmMoc291cmNlKS5tYXAoKG5hbWU6IHN0cmluZykgPT4gcGF0aC5ub3JtYWxpemUocGF0aC5qb2luKHNvdXJjZSwgbmFtZSkpKS5maWx0ZXIodGhpcy5pc0RpcmVjdG9yeSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdldEZpbGVzKGRpcjogc3RyaW5nKTpzdHJpbmdbXSB7XHJcbiAgICAgICAgcmV0dXJuIGZzLnJlYWRkaXJTeW5jKGRpcikubWFwKChuYW1lOiBzdHJpbmcpID0+IHBhdGgubm9ybWFsaXplKHBhdGguam9pbihkaXIsIG5hbWUpKSkuZmlsdGVyKHRoaXMuaXNGaWxlKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgb25GaWxlRXZlbnQoZTogc3RyaW5nLCBmOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5sb2NrZWQgfHwgZSAhPT0gXCJjaGFuZ2VcIikgeyByZXR1cm47IH1cclxuICAgICAgICB0aGlzLmxvY2soKTtcclxuXHJcbiAgICAgICAgdGhpcy5sb2coYE5vZGUuanMgRlNFdmVudDogJHtlfWAsYE5vZGUgRlNFdmVudCBGaWxlOiAke2Z9YCk7XHJcbiAgICAgICAgdGhpcy5lbWl0KFwiYWxsXCIsIFwiY2hhbmdlXCIsIGYpO1xyXG4gICAgICAgIHRoaXMuZW1pdChcImNoYW5nZVwiLCBmKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIGZzLndhdGNoIGV2ZW50IGhhbmRsZXIgZm9yIGRpcmVjdG9yaWVzXHJcbiAgICAgKiBXZSB3YXRjaCBkaXJlY3RvcmllcyBmb3IgYWRkLCByZW5hbWUgZGVsZXRlIGV2ZW50cyBzbyB3ZSBjYW4gYWRkIGFuZCByZW1vdmUgbmV3IGxpc3RlbmVycyBhcyBuZWNlc3NhcnlcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIGUge3N0cmluZ30gZXZlbnQgdHlwZVxyXG4gICAgICogQHBhcmFtIGYge3N0cmluZ30gZmlsZVxyXG4gICAgICogQHBhcmFtIGRpciB7c3RyaW5nfSB0aGUgZGlyZWN0b3J5XHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBvbkRpcmVjdG9yeUV2ZW50KGU6IHN0cmluZywgZjogc3RyaW5nLCBkaXI6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmxvY2tlZCB8fCBlICE9PSBcInJlbmFtZVwiKSB7IHJldHVybjsgfVxyXG4gICAgICAgIHRoaXMubG9jaygpO1xyXG5cclxuICAgICAgICB0aGlzLmxvZyhgUmF3IEZTRXZlbnQ6ICR7ZX0ke0VPTH1SYXcgRlNFdmVudCBGaWxlOiAke2Z9JHtFT0x9RGlyZWN0b3J5OiAke2Rpcn0ke0VPTH1gKTtcclxuICAgICAgICBjb25zdCBhYnMgPSBwYXRoLmpvaW4oZGlyLCBwYXRoLmJhc2VuYW1lKGYpKTtcclxuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoYWJzKSkge1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgcmVuYW1lZEZpbGUgPSB0aGlzLmdldFJlbmFtZWRGaWxlcyhkaXIpO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHJlbmFtZWRGaWxlICE9PSBcInVuZGVmaW5lZFwiKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZyhgT2xkIEZpbGU6ICR7YWJzfWApXHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvZyhgUmVuYW1lZCBGaWxlOiAke3JlbmFtZWRGaWxlfWApXHJcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoXCJhbGxcIiwgXCJyZW5hbWVcIiwgYWJzLCByZW5hbWVkRmlsZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoXCJyZW5hbWVcIiwgYWJzLCByZW5hbWVkRmlsZSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVdhdGNoZXIoYWJzKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdChcImFsbFwiLCBcImRlbGV0ZVwiLCBhYnMpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KFwiZGVsZXRlXCIsIGFicyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBpZiAoIXRoaXMuZmlsZXMuaW5jbHVkZXMoYWJzKSkge1xyXG4gICAgICAgICAgICAvLyBDcmVhdGVcclxuICAgICAgICAgICAgdGhpcy53YXRjaGVycy5wdXNoKHRoaXMuY3JlYXRlRmlsZVdhdGNoZXIoYWJzKSk7XHJcbiAgICAgICAgICAgIHRoaXMuZW1pdChcImFsbFwiLCBcImFkZFwiLCBhYnMpO1xyXG4gICAgICAgICAgICB0aGlzLmVtaXQoXCJhZGRcIiwgYWJzKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHJlbW92ZVdhdGNoZXIoZmlsZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3Qgd2F0Y2hlclN0cnVjdCA9IHRoaXMuZ2V0V2F0Y2hlcihmaWxlKTtcclxuICAgICAgICBpZiAodHlwZW9mIHdhdGNoZXJTdHJ1Y3QgIT09IFwidW5kZWZpbmVkXCIpIHsgXHJcbiAgICAgICAgICAgIHdhdGNoZXJTdHJ1Y3Qud2F0Y2hlci5jbG9zZSgpO1xyXG4gICAgICAgICAgICB0aGlzLndhdGNoZXJzLnNwbGljZSh0aGlzLndhdGNoZXJzLmluZGV4T2Yod2F0Y2hlclN0cnVjdCksIDEpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZ2V0UmVuYW1lZEZpbGVzKGRpcjogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICBjb25zdCBmaWxlcyA9IHRoaXMuZ2V0RmlsZXMoZGlyKTtcclxuICAgICAgICB0aGlzLmxvZyhcIkZpbGVzIG9uIERpc2s6XCIgKyBFT0wgKyBKU09OLnN0cmluZ2lmeShmaWxlcywgbnVsbCwgMikpO1xyXG4gICAgICAgIHRoaXMubG9nKFwiV2F0Y2hlZCBGaWxlczpcIiArIEVPTCArIEpTT04uc3RyaW5naWZ5KHRoaXMuZmlsZXMsIG51bGwsIDIpKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGYgb2YgZmlsZXMpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmZpbGVzLmluY2x1ZGVzKGYpKSB7IHJldHVybiBmOyB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBjcmVhdGVGaWxlV2F0Y2hlcihmaWxlOiBzdHJpbmcpOiBXYXRjaGVyU3RydWN0IHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB0YXJnZXQ6IGZpbGUsXHJcbiAgICAgICAgICAgIHdhdGNoZXI6IGZzLndhdGNoKGZpbGUsIHRoaXMub3B0aW9ucywgKGU6IHN0cmluZywgXykgPT4geyB0aGlzLm9uRmlsZUV2ZW50KGUsIGZpbGUpOyB9KVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbiAgICBwcm90ZWN0ZWQgY3JlYXRlRGlyV2F0Y2hlcihkaXI6IHN0cmluZyk6IFdhdGNoZXJTdHJ1Y3Qge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHRhcmdldDogZGlyLFxyXG4gICAgICAgICAgICB3YXRjaGVyOiBmcy53YXRjaChkaXIsIHRoaXMub3B0aW9ucywgKGU6IHN0cmluZywgZjogc3RyaW5nKSA9PiB7IHRoaXMub25EaXJlY3RvcnlFdmVudChlLCBmLCBkaXIpOyB9KVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdldFdhdGNoZXIoZmlsZW5hbWU6IHN0cmluZyk6IFdhdGNoZXJTdHJ1Y3Qge1xyXG4gICAgICAgIHJldHVybiB0aGlzLndhdGNoZXJzLmZpbmQoKHcpID0+IHBhdGgubm9ybWFsaXplKHcudGFyZ2V0KSA9PT0gcGF0aC5ub3JtYWxpemUoZmlsZW5hbWUpKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcHJvdGVjdGVkIGxvY2soKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5sb2NrZWQgPSB0cnVlO1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB0aGlzLmxvY2tlZCA9IGZhbHNlOyB9LCB0aGlzLm9wdGlvbnMubG9ja0R1cmF0aW9uKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBdHRhY2hzIHdhdGNoIGxpc3RlbmVycyBhbmQgc3RhcnRzIHdhdGNoaW5nIHNwZWNpZmllZCBmaWxlc1xyXG4gICAgICogQXZhaWxhYmxlIGV2ZW50cyBhcmUgXHJcbiAgICAgKiBgYWRkYCAtIEVtaXR0ZWQgd2hlbiBhIGZpbGUgaXMgY3JlYXRlZFxyXG4gICAgICogYGRlbGV0ZWAgLSBFbWl0dGVkIHdoZW4gYSBmaWxlIGlzIGRlbGV0ZWRcclxuICAgICAqIGBjaGFuZ2VgIC0gRW1pdHRlZCB3aGVuIGEgZmlsZSBjaGFuZ2UgaXMgZGV0ZWN0ZWQgXHJcbiAgICAgKiBgcmVuYW1lYCAtIEVtaXR0ZWQgd2hlbiBhIGZpbGUgaXMgcmVuYW1lZFxyXG4gICAgICogYGFsbGAgLSBFbWl0dGVkIGZvciBhbGwgdGhlIGFib3ZlIGV2ZW50c1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgU3RhcnQoKTogdGhpcyB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJXYXRjaGluZyBGaWxlczpcIiArIEVPTCArIHRoaXMuZmlsZXMubWFwKChmKSA9PiBgJHtmfWApLmpvaW4oRU9MKSk7XHJcbiAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIHRoaXMuZmlsZXMpIHtcclxuICAgICAgICAgICAgdGhpcy53YXRjaGVycy5wdXNoKHRoaXMuY3JlYXRlRmlsZVdhdGNoZXIoZmlsZSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmxvZyhcIldhdGNoaW5nIERpcmVjdG9yaWVzOlwiICsgRU9MICsgdGhpcy5kaXJlY3Rvcmllcy5tYXAoKGYpID0+IGAke2Z9YCkuam9pbihFT0wpKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGRpciBvZiB0aGlzLmRpcmVjdG9yaWVzKSB7XHJcbiAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMucHVzaCh0aGlzLmNyZWF0ZURpcldhdGNoZXIoZGlyKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxufVxyXG4iXX0=