"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const events_1 = require("events");
const globby_1 = require("globby");
const callsite_1 = __importDefault(require("callsite"));
const os_1 = require("os");
const colours_ts_1 = require("colours-ts");
if (!Array.prototype.unique) {
    Array.prototype.unique = function () {
        return this.filter((value, index) => {
            return this.indexOf(value) === index;
        });
    };
}
class Bewatch extends events_1.EventEmitter {
    /**
     * File Watching using NodeJS fs.watch
     * @param globPattern The glob or array of globs to match against
     * @param watchOptions Options object
     */
    constructor(globPattern, watchOptions = {}) {
        super();
        this.options = { lockDuration: 1000, absolute: true, encoding: "utf-8", persistent: true, recursive: true, verbose: false };
        this.watchers = [];
        this.locked = false;
        this.locks = [];
        this.options = { ...this.options, ...watchOptions };
        // Callsite Gets the directory of the file this constructor was called from so we can glob from there instead of here
        this.options.cwd = (typeof this.options.cwd === "undefined") ? path.dirname(callsite_1.default()[1].getFileName()) : this.options.cwd;
        this.log("Working Directory", this.options.cwd);
        this.log("Options", this.options);
        this.files = this.globFiles(globPattern).map((g) => path.normalize(g));
        this.directories = this.files.map((f) => path.dirname(f)).unique();
    }
    log(...logargs) {
        if (this.options.verbose) {
            // tslint:disable-next-line:no-console
            console.log(`${colours_ts_1.Colours(`Bewatch::${callsite_1.default()[1].getFunctionName()}`, "cyan")}`, ...logargs, os_1.EOL);
        }
    }
    globFiles(globPattern) {
        return globby_1.sync(globPattern, this.options);
    }
    isDirectory(source) {
        return fs.lstatSync(source).isDirectory();
    }
    isFile(source) {
        return !fs.lstatSync(source).isDirectory();
    }
    getDirectories(source) {
        return fs.readdirSync(source).map((name) => path.normalize(path.join(source, name))).filter(this.isDirectory);
    }
    getFiles(dir) {
        return fs.readdirSync(dir).map((name) => path.normalize(path.join(dir, name))).filter(this.isFile);
    }
    onFileEvent(e, f) {
        if (this.locked || e !== "change") {
            return;
        }
        this.lock();
        this.log(`${colours_ts_1.Colours("Node.js FSEvent:", "yellow")} ${e} ${colours_ts_1.Colours("Node FSEvent File:", "yellow")} ${f}`);
        this.emit("all", "change", f);
        this.emit("change", f);
    }
    /**
     * fs.watch event handler for directories
     * We watch directories for add, rename delete events so we can add and remove new listeners as necessary
     *
     * @param e {string} event type
     * @param f {string} file
     * @param dir {string} the directory
     */
    onDirectoryEvent(e, f, dir) {
        if (this.locked || e !== "rename") {
            return;
        }
        this.lock();
        this.log(`${colours_ts_1.Colours("Raw FSEvent:", "yellow")} ${e}${os_1.EOL}${colours_ts_1.Colours("Raw FSEvent File:", "yellow")} ${f}${os_1.EOL}${colours_ts_1.Colours("Directory:", "yellow")} ${dir}${os_1.EOL}`);
        const abs = path.join(dir, path.basename(f));
        if (!fs.existsSync(abs)) {
            const renamedFile = this.getRenamedFiles(dir);
            if (typeof renamedFile !== "undefined") {
                this.log(`Old File: ${abs}`);
                this.log(`Renamed File: ${renamedFile}`);
                this.emit("all", "rename", abs, renamedFile);
                this.emit("rename", abs, renamedFile);
                this.removeWatcher(abs);
            }
            else {
                this.emit("all", "delete", abs);
                this.emit("delete", abs);
            }
            return;
        }
        if (!this.files.includes(abs)) {
            // Create
            this.watchers.push(this.createFileWatcher(abs));
            this.emit("all", "add", abs);
            this.emit("add", abs);
        }
    }
    removeWatcher(file) {
        const watcherStruct = this.getWatcher(file);
        if (typeof watcherStruct !== "undefined") {
            watcherStruct.watcher.close();
            this.watchers.splice(this.watchers.indexOf(watcherStruct), 1);
        }
    }
    getRenamedFiles(dir) {
        const files = this.getFiles(dir);
        this.log(colours_ts_1.Colours("Files on Disk:", "yellow") + os_1.EOL + JSON.stringify(files, null, 2));
        this.log(colours_ts_1.Colours("Watched Files:", "yellow") + os_1.EOL + JSON.stringify(this.files, null, 2));
        for (const f of files) {
            if (!this.files.includes(f)) {
                return f;
            }
        }
        return undefined;
    }
    createFileWatcher(file) {
        return {
            target: file,
            watcher: fs.watch(file, this.options, (e, _) => { this.onFileEvent(e, file); })
        };
    }
    createDirWatcher(dir) {
        return {
            target: dir,
            watcher: fs.watch(dir, this.options, (e, f) => { this.onDirectoryEvent(e, f, dir); })
        };
    }
    getWatcher(filename) {
        return this.watchers.find((w) => path.normalize(w.target) === path.normalize(filename));
    }
    lock() {
        this.locked = true;
        setTimeout(() => { this.locked = false; }, this.options.lockDuration);
    }
    /**
     * Attachs watch listeners and starts watching specified files
     * Available events are
     * `add` - Emitted when a file is created
     * `delete` - Emitted when a file is deleted
     * `change` - Emitted when a file change is detected
     * `rename` - Emitted when a file is renamed
     * `all` - Emitted for all the above events
     */
    Start() {
        this.log("Watching Files:" + os_1.EOL + this.files.map((f) => `${colours_ts_1.Colours(f, "green")}`).join(os_1.EOL));
        for (const file of this.files) {
            this.watchers.push(this.createFileWatcher(file));
        }
        this.log("Watching Directories:" + os_1.EOL + this.directories.map((f) => `${colours_ts_1.Colours(f, "green")}`).join(os_1.EOL));
        for (const dir of this.directories) {
            this.watchers.push(this.createDirWatcher(dir));
        }
        return this;
    }
}
exports.Bewatch = Bewatch;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmV3YXRjaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9CZXdhdGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEseUJBQTBCO0FBQzFCLDZCQUE4QjtBQUM5QixtQ0FBc0M7QUFDdEMsbUNBQXNDO0FBQ3RDLHdEQUFnQztBQUVoQywyQkFBeUI7QUFDekIsMkNBQXFDO0FBb0RyQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7SUFDekIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUc7UUFDckIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBVSxFQUFFLEtBQWEsRUFBRSxFQUFFO1lBQzdDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxLQUFLLENBQUM7UUFDekMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUE7Q0FDSjtBQUlELGFBQXFCLFNBQVEscUJBQVk7SUFRckM7Ozs7T0FJRztJQUNILFlBQVksV0FBOEIsRUFBRSxlQUErQixFQUFFO1FBQ3pFLEtBQUssRUFBRSxDQUFDO1FBWEYsWUFBTyxHQUFtQixFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUM7UUFDdkksYUFBUSxHQUFvQixFQUFFLENBQUM7UUFDL0IsV0FBTSxHQUFZLEtBQUssQ0FBQztRQUN4QixVQUFLLEdBQWtCLEVBQUUsQ0FBQztRQVNoQyxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsWUFBWSxFQUFFLENBQUM7UUFFcEQscUhBQXFIO1FBQ3JILElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsT0FBTyxJQUFJLENBQUMs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QUFFO1lBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ2xEO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUNKO0FBdEtELDBCQXNLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyA9IHJlcXVpcmUoXCJmc1wiKTtcclxuaW1wb3J0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSBcImV2ZW50c1wiO1xyXG5pbXBvcnQgeyBzeW5jIGFzIGdsb2IgfSBmcm9tIFwiZ2xvYmJ5XCI7XHJcbmltcG9ydCBDYWxsc2l0ZSBmcm9tIFwiY2FsbHNpdGVcIjtcclxuaW1wb3J0IHsgT3B0aW9ucyBhcyBGYXN0R2xvYk9wdGlvbnMgfSBmcm9tICdmYXN0LWdsb2InO1xyXG5pbXBvcnQgeyBFT0wgfSBmcm9tIFwib3NcIjtcclxuaW1wb3J0IHsgQ29sb3VycyB9IGZyb20gXCJjb2xvdXJzLXRzXCI7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEZTV2F0Y2hPcHRpb25zIHtcclxuICAgIGVuY29kaW5nPzogc3RyaW5nO1xyXG4gICAgcGVyc2lzdGVudD86IGJvb2xlYW47XHJcbiAgICByZWN1cnNpdmU/OiBib29sZWFuO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFdhdGNoZXJTdHJ1Y3Qge1xyXG4gICAgdGFyZ2V0OiBzdHJpbmc7XHJcbiAgICB3YXRjaGVyOiBmcy5GU1dhdGNoZXI7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRlNFdmVudExvY2sge1xyXG4gICAgZmlsZW5hbWU6IHN0cmluZztcclxuICAgIGxvY2tUaW1lOiBudW1iZXI7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRmlsZURlc2NyaXB0b3Ige1xyXG4gICAgYmFzZW5hbWU6IHN0cmluZztcclxuICAgIGZkOiBudW1iZXI7XHJcbiAgICBkaXJuYW1lOiBzdHJpbmc7XHJcbiAgICBhYnNvbHV0ZTogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFdhdGNoZXJPcHRpb25zIGV4dGVuZHMgRlNXYXRjaE9wdGlvbnMsIEZhc3RHbG9iT3B0aW9ucyB7XHJcbiAgICAvKipcclxuICAgICAqIFRoZSBkZWxheSBpbiBtaWxsaXNlY29uZHMgYmVmb3JlIGVtaXR0aW5nIGEgbmV3IEV2ZW50XHJcbiAgICAgKiBOb2RlSlMgZnMud2F0Y2ggZW1pdHMgZHVwbGljYXRlIGV2ZW50cyBhbW9uZyBvdGhlciBpZGlvc3luY3Jhc2VzLCB0aGlzIGNvbnRyb2xzIGhvdyBsb25nIHdlIHdhaXQgYmVmb3JlIHJlbGF5aW5nIGV2ZW50c1xyXG4gICAgICogQGRlZmF1bHQgNTAwMFxyXG4gICAgICovXHJcbiAgICBsb2NrRHVyYXRpb24/OiBudW1iZXI7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBFbmFibGVzIHZlcmJvc2UgbG9nZ2luZ1xyXG4gICAgICogQGRlZmF1bHQgZmFsc2VcclxuICAgICAqL1xyXG4gICAgdmVyYm9zZT86IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRGVzY3JpcHRvckRpcmVjdG9yeSB7XHJcbiAgICBkaXJuYW1lOiBzdHJpbmc7XHJcbiAgICBkZXNjcmlwdG9yczogRmlsZURlc2NyaXB0b3JbXTtcclxufVxyXG5cclxuLy8gQWRkIHRoZSB1bmlxdWUgZXh0ZW5zaW9uIG1ldGhvZCB0byB0aGUgQXJyYXkgcHJvdG90eXBlXHJcbmRlY2xhcmUgZ2xvYmFsIHtcclxuICAgIGludGVyZmFjZSBBcnJheTxUPiB7XHJcbiAgICAgICAgdW5pcXVlOiAoKSA9PiBBcnJheTxUPjtcclxuICAgIH1cclxufVxyXG5cclxuaWYgKCFBcnJheS5wcm90b3R5cGUudW5pcXVlKSB7XHJcbiAgICBBcnJheS5wcm90b3R5cGUudW5pcXVlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmZpbHRlcigodmFsdWU6IGFueSwgaW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pbmRleE9mKHZhbHVlKSA9PT0gaW5kZXg7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIExlZ2FsRXZlbnRzID0gXCJhZGRcIiB8IFwiZGVsZXRlXCIgfCBcImNoYW5nZVwiIHwgXCJyZW5hbWVcIiB8IFwiYWxsXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgQmV3YXRjaCBleHRlbmRzIEV2ZW50RW1pdHRlciB7XHJcbiAgICBwcm90ZWN0ZWQgZmlsZXM6IHN0cmluZ1tdO1xyXG4gICAgcHJvdGVjdGVkIGRpcmVjdG9yaWVzOiBzdHJpbmdbXTtcclxuICAgIHByb3RlY3RlZCBvcHRpb25zOiBXYXRjaGVyT3B0aW9ucyA9IHsgbG9ja0R1cmF0aW9uOiAxMDAwLCBhYnNvbHV0ZTogdHJ1ZSwgZW5jb2Rpbmc6IFwidXRmLThcIiwgcGVyc2lzdGVudDogdHJ1ZSwgcmVjdXJzaXZlOiB0cnVlLCB2ZXJib3NlOiBmYWxzZSB9O1xyXG4gICAgcHJvdGVjdGVkIHdhdGNoZXJzOiBXYXRjaGVyU3RydWN0W10gPSBbXTtcclxuICAgIHByb3RlY3RlZCBsb2NrZWQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByb3RlY3RlZCBsb2NrczogRlNFdmVudExvY2tbXSA9IFtdO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogRmlsZSBXYXRjaGluZyB1c2luZyBOb2RlSlMgZnMud2F0Y2hcclxuICAgICAqIEBwYXJhbSBnbG9iUGF0dGVybiBUaGUgZ2xvYiBvciBhcnJheSBvZiBnbG9icyB0byBtYXRjaCBhZ2FpbnN0XHJcbiAgICAgKiBAcGFyYW0gd2F0Y2hPcHRpb25zIE9wdGlvbnMgb2JqZWN0IFxyXG4gICAgICovXHJcbiAgICBjb25zdHJ1Y3RvcihnbG9iUGF0dGVybjogc3RyaW5nIHwgc3RyaW5nW10sIHdhdGNoT3B0aW9uczogV2F0Y2hlck9wdGlvbnMgPSB7fSkge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zID0geyAuLi50aGlzLm9wdGlvbnMsIC4uLndhdGNoT3B0aW9ucyB9O1xyXG5cclxuICAgICAgICAvLyBDYWxsc2l0ZSBHZXRzIHRoZSBkaXJlY3Rvcnkgb2YgdGhlIGZpbGUgdGhpcyBjb25zdHJ1Y3RvciB3YXMgY2FsbGVkIGZyb20gc28gd2UgY2FuIGdsb2IgZnJvbSB0aGVyZSBpbnN0ZWFkIG9mIGhlcmVcclxuICAgICAgICB0aGlzLm9wdGlvbnMuY3dkID0gKHR5cGVvZiB0aGlzLm9wdGlvbnMuY3dkID09PSBcInVuZGVmaW5lZFwiKSA/IHBhdGguZGlybmFtZShDYWxsc2l0ZSgpWzFdLmdldEZpbGVOYW1lKCkpIDogdGhpcy5vcHRpb25zLmN3ZDtcclxuXHJcbiAgICAgICAgdGhpcy5sb2coXCJXb3JraW5nIERpcmVjdG9yeVwiLCB0aGlzLm9wdGlvbnMuY3dkKTtcclxuICAgICAgICB0aGlzLmxvZyhcIk9wdGlvbnNcIiwgdGhpcy5vcHRpb25zKTtcclxuXHJcbiAgICAgICAgdGhpcy5maWxlcyA9IHRoaXMuZ2xvYkZpbGVzKGdsb2JQYXR0ZXJuKS5tYXAoKGcpID0+IHBhdGgubm9ybWFsaXplKGcpKTtcclxuICAgICAgICB0aGlzLmRpcmVjdG9yaWVzID0gdGhpcy5maWxlcy5tYXAoKGYpID0+IHBhdGguZGlybmFtZShmKSkudW5pcXVlKCk7XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgbG9nKC4uLmxvZ2FyZ3M6IGFueVtdKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy52ZXJib3NlKSB7XHJcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke0NvbG91cnMoYEJld2F0Y2g6OiR7Q2FsbHNpdGUoKVsxXS5nZXRGdW5jdGlvbk5hbWUoKX1gLCBcImN5YW5cIikgfWAsIC4uLmxvZ2FyZ3MsIEVPTCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnbG9iRmlsZXMoZ2xvYlBhdHRlcm46IHN0cmluZyB8IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG4gICAgICAgIHJldHVybiBnbG9iKGdsb2JQYXR0ZXJuLCB0aGlzLm9wdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBpc0RpcmVjdG9yeShzb3VyY2U6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiBmcy5sc3RhdFN5bmMoc291cmNlKS5pc0RpcmVjdG9yeSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBpc0ZpbGUoc291cmNlOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gIWZzLmxzdGF0U3luYyhzb3VyY2UpLmlzRGlyZWN0b3J5KCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdldERpcmVjdG9yaWVzKHNvdXJjZTogc3RyaW5nKTogc3RyaW5nW10ge1xyXG4gICAgICAgIHJldHVybiBmcy5yZWFkZGlyU3luYyhzb3VyY2UpLm1hcCgobmFtZTogc3RyaW5nKSA9PiBwYXRoLm5vcm1hbGl6ZShwYXRoLmpvaW4oc291cmNlLCBuYW1lKSkpLmZpbHRlcih0aGlzLmlzRGlyZWN0b3J5KTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZ2V0RmlsZXMoZGlyOiBzdHJpbmcpOnN0cmluZ1tdIHtcclxuICAgICAgICByZXR1cm4gZnMucmVhZGRpclN5bmMoZGlyKS5tYXAoKG5hbWU6IHN0cmluZykgPT4gcGF0aC5ub3JtYWxpemUocGF0aC5qb2luKGRpciwgbmFtZSkpKS5maWx0ZXIodGhpcy5pc0ZpbGUpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBvbkZpbGVFdmVudChlOiBzdHJpbmcsIGY6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmxvY2tlZCB8fCBlICE9PSBcImNoYW5nZVwiKSB7IHJldHVybjsgfVxyXG4gICAgICAgIHRoaXMubG9jaygpO1xyXG5cclxuICAgICAgICB0aGlzLmxvZyhgJHtDb2xvdXJzKFwiTm9kZS5qcyBGU0V2ZW50OlwiLCBcInllbGxvd1wiKX0gJHtlfSAke0NvbG91cnMoXCJOb2RlIEZTRXZlbnQgRmlsZTpcIiwgXCJ5ZWxsb3dcIil9ICR7Zn1gKTtcclxuICAgICAgICB0aGlzLmVtaXQoXCJhbGxcIiwgXCJjaGFuZ2VcIiwgZik7XHJcbiAgICAgICAgdGhpcy5lbWl0KFwiY2hhbmdlXCIsIGYpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogZnMud2F0Y2ggZXZlbnQgaGFuZGxlciBmb3IgZGlyZWN0b3JpZXNcclxuICAgICAqIFdlIHdhdGNoIGRpcmVjdG9yaWVzIGZvciBhZGQsIHJlbmFtZSBkZWxldGUgZXZlbnRzIHNvIHdlIGNhbiBhZGQgYW5kIHJlbW92ZSBuZXcgbGlzdGVuZXJzIGFzIG5lY2Vzc2FyeVxyXG4gICAgICogXHJcbiAgICAgKiBAcGFyYW0gZSB7c3RyaW5nfSBldmVudCB0eXBlXHJcbiAgICAgKiBAcGFyYW0gZiB7c3RyaW5nfSBmaWxlXHJcbiAgICAgKiBAcGFyYW0gZGlyIHtzdHJpbmd9IHRoZSBkaXJlY3RvcnlcclxuICAgICAqL1xyXG4gICAgcHJvdGVjdGVkIG9uRGlyZWN0b3J5RXZlbnQoZTogc3RyaW5nLCBmOiBzdHJpbmcsIGRpcjogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMubG9ja2VkIHx8IGUgIT09IFwicmVuYW1lXCIpIHsgcmV0dXJuOyB9XHJcbiAgICAgICAgdGhpcy5sb2NrKCk7XHJcblxyXG4gICAgICAgIHRoaXMubG9nKGAke0NvbG91cnMoXCJSYXcgRlNFdmVudDpcIiwgXCJ5ZWxsb3dcIil9ICR7ZX0ke0VPTH0ke0NvbG91cnMoXCJSYXcgRlNFdmVudCBGaWxlOlwiLCBcInllbGxvd1wiKX0gJHtmfSR7RU9MfSR7Q29sb3VycyhcIkRpcmVjdG9yeTpcIiwgXCJ5ZWxsb3dcIil9ICR7ZGlyfSR7RU9MfWApO1xyXG4gICAgICAgIGNvbnN0IGFicyA9IHBhdGguam9pbihkaXIsIHBhdGguYmFzZW5hbWUoZikpO1xyXG4gICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhhYnMpKSB7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBjb25zdCByZW5hbWVkRmlsZSA9IHRoaXMuZ2V0UmVuYW1lZEZpbGVzKGRpcik7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVuYW1lZEZpbGUgIT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nKGBPbGQgRmlsZTogJHthYnN9YClcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nKGBSZW5hbWVkIEZpbGU6ICR7cmVuYW1lZEZpbGV9YClcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdChcImFsbFwiLCBcInJlbmFtZVwiLCBhYnMsIHJlbmFtZWRGaWxlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdChcInJlbmFtZVwiLCBhYnMsIHJlbmFtZWRGaWxlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlV2F0Y2hlcihhYnMpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KFwiYWxsXCIsIFwiZGVsZXRlXCIsIGFicyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoXCJkZWxldGVcIiwgYWJzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGlmICghdGhpcy5maWxlcy5pbmNsdWRlcyhhYnMpKSB7XHJcbiAgICAgICAgICAgIC8vIENyZWF0ZVxyXG4gICAgICAgICAgICB0aGlzLndhdGNoZXJzLnB1c2godGhpcy5jcmVhdGVGaWxlV2F0Y2hlcihhYnMpKTtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KFwiYWxsXCIsIFwiYWRkXCIsIGFicyk7XHJcbiAgICAgICAgICAgIHRoaXMuZW1pdChcImFkZFwiLCBhYnMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgcmVtb3ZlV2F0Y2hlcihmaWxlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCB3YXRjaGVyU3RydWN0ID0gdGhpcy5nZXRXYXRjaGVyKGZpbGUpO1xyXG4gICAgICAgIGlmICh0eXBlb2Ygd2F0Y2hlclN0cnVjdCAhPT0gXCJ1bmRlZmluZWRcIikgeyBcclxuICAgICAgICAgICAgd2F0Y2hlclN0cnVjdC53YXRjaGVyLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMuc3BsaWNlKHRoaXMud2F0Y2hlcnMuaW5kZXhPZih3YXRjaGVyU3RydWN0KSwgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXRSZW5hbWVkRmlsZXMoZGlyOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5nZXRGaWxlcyhkaXIpO1xyXG4gICAgICAgIHRoaXMubG9nKENvbG91cnMoXCJGaWxlcyBvbiBEaXNrOlwiLCBcInllbGxvd1wiKSArIEVPTCArIEpTT04uc3RyaW5naWZ5KGZpbGVzLCBudWxsLCAyKSk7XHJcbiAgICAgICAgdGhpcy5sb2coQ29sb3VycyhcIldhdGNoZWQgRmlsZXM6XCIsIFwieWVsbG93XCIpICsgRU9MICsgSlNPTi5zdHJpbmdpZnkodGhpcy5maWxlcywgbnVsbCwgMikpO1xyXG4gICAgICAgIGZvciAoY29uc3QgZiBvZiBmaWxlcykge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuZmlsZXMuaW5jbHVkZXMoZikpIHsgcmV0dXJuIGY7IH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGNyZWF0ZUZpbGVXYXRjaGVyKGZpbGU6IHN0cmluZyk6IFdhdGNoZXJTdHJ1Y3Qge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHRhcmdldDogZmlsZSxcclxuICAgICAgICAgICAgd2F0Y2hlcjogZnMud2F0Y2goZmlsZSwgdGhpcy5vcHRpb25zLCAoZTogc3RyaW5nLCBfKSA9PiB7IHRoaXMub25GaWxlRXZlbnQoZSwgZmlsZSk7IH0pXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIHByb3RlY3RlZCBjcmVhdGVEaXJXYXRjaGVyKGRpcjogc3RyaW5nKTogV2F0Y2hlclN0cnVjdCB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdGFyZ2V0OiBkaXIsXHJcbiAgICAgICAgICAgIHdhdGNoZXI6IGZzLndhdGNoKGRpciwgdGhpcy5vcHRpb25zLCAoZTogc3RyaW5nLCBmOiBzdHJpbmcpID0+IHsgdGhpcy5vbkRpcmVjdG9yeUV2ZW50KGUsIGYsIGRpcik7IH0pXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZ2V0V2F0Y2hlcihmaWxlbmFtZTogc3RyaW5nKTogV2F0Y2hlclN0cnVjdCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMud2F0Y2hlcnMuZmluZCgodykgPT4gcGF0aC5ub3JtYWxpemUody50YXJnZXQpID09PSBwYXRoLm5vcm1hbGl6ZShmaWxlbmFtZSkpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBwcm90ZWN0ZWQgbG9jaygpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmxvY2tlZCA9IHRydWU7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7IHRoaXMubG9ja2VkID0gZmFsc2U7IH0sIHRoaXMub3B0aW9ucy5sb2NrRHVyYXRpb24pO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICAvKipcclxuICAgICAqIEF0dGFjaHMgd2F0Y2ggbGlzdGVuZXJzIGFuZCBzdGFydHMgd2F0Y2hpbmcgc3BlY2lmaWVkIGZpbGVzXHJcbiAgICAgKiBBdmFpbGFibGUgZXZlbnRzIGFyZSBcclxuICAgICAqIGBhZGRgIC0gRW1pdHRlZCB3aGVuIGEgZmlsZSBpcyBjcmVhdGVkXHJcbiAgICAgKiBgZGVsZXRlYCAtIEVtaXR0ZWQgd2hlbiBhIGZpbGUgaXMgZGVsZXRlZFxyXG4gICAgICogYGNoYW5nZWAgLSBFbWl0dGVkIHdoZW4gYSBmaWxlIGNoYW5nZSBpcyBkZXRlY3RlZCBcclxuICAgICAqIGByZW5hbWVgIC0gRW1pdHRlZCB3aGVuIGEgZmlsZSBpcyByZW5hbWVkXHJcbiAgICAgKiBgYWxsYCAtIEVtaXR0ZWQgZm9yIGFsbCB0aGUgYWJvdmUgZXZlbnRzXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBTdGFydCgpOiB0aGlzIHtcclxuICAgICAgICB0aGlzLmxvZyhcIldhdGNoaW5nIEZpbGVzOlwiICsgRU9MICsgdGhpcy5maWxlcy5tYXAoKGYpID0+IGAke0NvbG91cnMoZiwgXCJncmVlblwiKX1gKS5qb2luKEVPTCkpO1xyXG4gICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiB0aGlzLmZpbGVzKSB7XHJcbiAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMucHVzaCh0aGlzLmNyZWF0ZUZpbGVXYXRjaGVyKGZpbGUpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5sb2coXCJXYXRjaGluZyBEaXJlY3RvcmllczpcIiArIEVPTCArIHRoaXMuZGlyZWN0b3JpZXMubWFwKChmKSA9PiBgJHtDb2xvdXJzKGYsIFwiZ3JlZW5cIil9YCkuam9pbihFT0wpKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGRpciBvZiB0aGlzLmRpcmVjdG9yaWVzKSB7XHJcbiAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMucHVzaCh0aGlzLmNyZWF0ZURpcldhdGNoZXIoZGlyKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxufVxyXG4iXX0=